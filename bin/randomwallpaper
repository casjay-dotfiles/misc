#!/usr/bin/env bash

APPNAME="$(basename $0)"
USER="${SUDO_USER:-${USER}}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# @Author      : Jason
# @Contact     : casjaysdev@casjay.net
# @File        : randomwallpaper
# @Created     : 08/18/2020
# @License     : WTFPL
# @Copyright   : Copyright (c) CasjaysDev
# @Description : Set a random wallpaper
#
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Main function

send_notify_wp() {
  command -v notify-send >/dev/null 2>&1 &&
    notify-send "Wallpaper Changer" "Wallpaper has been changed to $RAND" ||
    notify-send "Wallpaper Changer" "Failed to change the wallpaper"
}

xfce_change_wp() {
  xfconf-query --channel xfce4-desktop --list | grep last-image | while read path; do
    xfconf-query --channel xfce4-desktop --property $path --set $RAND
  done
}

randomwallpaper() {
  [ ! -z "$WALLPAPERS" ] || exit 1

  RAND=$(find "$WALLPAPERS" -type f -iname "*.jpg" -or -iname "*.jpeg" -or -iname "*.png" -or -iname "*.tif" -or -iname "*.bmp" -or -iname "*.gif" -not -path "*/.git/*" 2>/dev/null | sort -R | head -1)

  [ ! -z "$RAND" ] || exit 1

  if cmd_exists xfconf-query >/dev/null 2>&1 && [[ "$DESKTOP_SESSION" =~ "xfce4" ]]; then
    xfce_change_wp && send_notify_wp || cmd_exists feh >/dev/null 2>&1 && feh --bg-fill "$RAND" && send_notify_wp

  elif cmd_exists xwallpaper >/dev/null 2>&1; then
    xwallpaper --maximize "$RAND" && send_notify_wp

  fi
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# execute function
randomwallpaper "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# end
