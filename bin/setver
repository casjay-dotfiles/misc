#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
APPNAME="setverfile"
VERSION="031620211858-git"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"
SRC_DIR="${BASH_SOURCE%/*}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#set opts

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : 031620211858-git
# @Author        : Jason Hempstead
# @Contact       : jason@casjaysdev.com
# @License       : LICENSE.md
# @ReadME        : setverfile --help
# @Copyright     : Copyright: (c) 2021 Jason Hempstead, CasjaysDev
# @Created       : Tuesday, Mar 16, 2021 20:52 EDT
# @File          : setverfile
# @Description   : Set the version for git repo
# @TODO          : Refactor code
# @Other         :
# @Resource      :
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Main function file
if [ -f "$SRC_DIR/functions.bash" ]; then
  FUNCTIONS_DIR="$SRC_DIR"
  . "$FUNCTIONS_DIR/functions.bash"
elif [ -f "$HOME/.local/bin/functions.bash" ]; then
  FUNCTIONS_DIR="$HOME/.local/bin"
  . "$FUNCTIONS_DIR/functions.bash"
else
  printf "\t\t\033[0;31m%s \033[0m\n" "Couldn't source the functions file from $FUNCTIONS_DIR"
  return 1
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# helper function
__version() { app_version; }
__help() {
  app_help "Usage: setverfile  -  setverfile --version"  \
    "-d --dir               -  set working dir"
    "-c, --config           -  create config file"
    "-v, --version          -  display version" \
    "-h, --help             -  display help"
}
__config_gen() {
  local CONFDIR="$HOME/.config/setverfile"
  local CONFFILE="settings.conf"
  printf_green "Generating the config file in"
  printf_green "$CONFDIR/$CONFFILE"
  [ -d "$CONFDIR" ] || mkdir -p "$CONFDIR"
  [ -f "$CONFDIR/$CONFFILE" ] && cp -Rf "$CONFDIR/$CONFFILE" "$CONFDIR/$CONFFILE.$$"
  echo 'SETVER_FILE='"$SETVER_FILE"''
  echo 'SETVER_FORMAT='"$SETVER_FORMAT"'' >"$CONFDIR/$CONFFILE"
  echo 'SETVER_TYPE='"$SETVER_TYPE"'' >> "$CONFDIR/$CONFFILE"
  [ -f "$CONFDIR/$CONFFILE" ] && printf_green "Config file has been created" || \
    printf_red "Failed to create the config file"
  exit $?
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Main function
main() {
  local OPTS SHORTOPTS LONGOPTS setopts SETVER_FORMAT SETVER_TYPE
  local SHORTOPTS="c,v,h,d:,f:"
  local LONGOPTS="config,version,help,dir:,file:"
  local SETVER_FORMAT="${VERSION_DATE_FORMAT:-%Y%m%d%H%M-git}"
  local SETVER_TYPE="-git"
  local SETVER_FILE="version.txt"
  local OPTS="$@"
  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  datecmd() { date +"${SETVER_FORMAT}${SETVER_TYPE}"; }
  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  [ -f "$CONFDIR/$CONFFILE" ] && . "$CONFDIR/$CONFFILE"
  [ -f "$1" ] && OPTS=setfile && FILE="$1" && shift 1 || FILE="$SETVER_FILE"
  [ -d "$1" ] && MYCURRDIR="$1" && shift 1 || MYCURRDIR="$(__git_top_dir "$MYCURRDIR")"
  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # options
  local setopts=$(getopt -o "$SHORTOPTS" --long "$LONGOPTS" -n "setverfile" -- "$@" 2>/dev/null)
  eval set -- "$setopts" 2>/dev/null
  while :; do
    case $1 in
      -v | --version) __version ;;
      -h | --help) __help ;;
      -c | --config) __config_gen ;;
      -d | --dir) shift; MYCURRDIR="$1" ;;
      -f | --file) shift; OPTS=setfile; FILE="$1";;
      -s | --show) [ -f "$MYCURRDIR/$FILE" ] && printf_green "$MYCURRDIR/$FILE" || printf_red "$MYCURRDIR/$FILE doesn't exist" ;;
      --) break ;;
      *) break ;;
    esac
    shift
  done
  [ -d "$MYCURRDIR" ] || printf_mkdir "$MYCURRDIR"
  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # Required app check
  cmd_exists --error bash || exit 1
  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # begin main app
  case $OPTS in
    setfile | create)
      if_else '[ -f "$MYCURRDIR/" ]'
      datecmd >"$FILE" ;;
    *) datecmd ;;
  esac
  # lets exit with code
  return "${exitCode:-0}"
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# execute function
main "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
exit $?
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end

